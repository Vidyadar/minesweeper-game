<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minesweeper</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nft.storage/dist/bundle.esm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="game-container">
    <div class="controls">
      <button id="reset-btn">😀</button>
      <span id="timer">000</span>
      <span id="mines-count">010</span>
    </div>
    <div id="minefield"></div>
    <div class="share-buttons">
      <button class="share-btn" id="share-result-btn">🏆 Share Result</button>
      <button class="share-btn" id="mint-nft-btn" style="display:none;">🎨 Mint as NFT</button>
    </div>
  </div>

  <script>
    // ---- Config ----
    const NFT_STORAGE_KEY = "1144cc8a.332c392bfee740c9b6794dca1daf979a";
    const CONTRACT_ADDRESS = "0xe998e76dA35333bCa55d5c8375E8E537Bfe7F819";
    const CONTRACT_ABI = [
      "function mint(address to, string memory tokenURI) external returns (uint256)",
      "function nextTokenId() view returns (uint256)"
    ];

    let provider, signer, nftContract, userAddress;

    async function connectWallet() {
      if (!window.ethereum) throw new Error("Install MetaMask");
      await window.ethereum.request({ method: "eth_requestAccounts" });
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      nftContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    }

    async function uploadToNFTStorage(gameResult, imageBlob) {
      const client = new NFTStorage({ token: NFT_STORAGE_KEY });

      const metadata = await client.store({
        name: `Minesweeper - ${gameResult.difficulty}`,
        description: `I played Minesweeper and ${gameResult.win ? "won" : "lost"} in ${gameResult.time}s`,
        image: new File([imageBlob], "result.png", { type: "image/png" }),
        properties: gameResult
      });

      return metadata.url;
    }

    async function mintGameNFT(gameResult) {
      try {
        if (!signer) await connectWallet();

        // Capture the minefield as an image
        const minefield = document.getElementById("minefield");
        const canvas = await html2canvas(minefield);
        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));

        // Upload to NFT.Storage
        const tokenURI = await uploadToNFTStorage(gameResult, blob);

        // Mint
        const tx = await nftContract.mint(userAddress, tokenURI);
        alert("Minting NFT... " + tx.hash);

        await tx.wait();
        alert("✅ Minted! View Metadata: " + tokenURI);
      } catch (err) {
        console.error(err);
        alert("❌ Mint failed: " + err.message);
      }
    }

    // ---- Minesweeper Class (your full existing code goes here) ----
    class Minesweeper {
      constructor() {
        this.rows = 9;
        this.cols = 9;
        this.mineCount = 10;
        this.flags = 0;
        this.gameState = "playing";
        this.difficulty = "Easy";
        this.elapsedTime = 0;
        this.timer = null;
        this.setupEventListeners();
      }

      setupEventListeners() {
        document.getElementById("share-result-btn").addEventListener("click", async () => {
          if (this.gameState === "playing") {
            alert("Finish the game first!");
            return;
          }
          const doMint = confirm("Do you want to mint this game as NFT?");
          if (!doMint) {
            alert("Shared normally!");
            return;
          }
          const result = {
            difficulty: this.difficulty,
            time: this.elapsedTime,
            win: this.gameState === "won"
          };
          await mintGameNFT(result);
        });

        document.getElementById("mint-nft-btn").addEventListener("click", async () => {
          if (this.gameState === "playing") {
            alert("Finish the game first!");
            return;
          }
          const result = {
            difficulty: this.difficulty,
            time: this.elapsedTime,
            win: this.gameState === "won"
          };
          await mintGameNFT(result);
        });
      }

      gameOver(won) {
        this.gameState = won ? "won" : "lost";
        document.getElementById("mint-nft-btn").style.display = "inline-flex";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      window.gameInstance = new Minesweeper();
    });
  </script>
</body>
</html>
