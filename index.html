<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minesweeper - Farcaster Game</title>

  <!-- Essential Open Graph Meta Tags -->
  <meta property="og:title" content="üí£ Minesweeper Game" />
  <meta property="og:description" content="Can you clear the minefield? 3 difficulty levels, beat the clock, mobile-friendly!" />
  <meta property="og:image" content="https://minesweeper-game-pearl.vercel.app/assets/preview.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="https://minesweeper-game-pearl.vercel.app/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Minesweeper Game" />

  <!-- Farcaster Miniapp Meta -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://minesweeper-game-pearl.vercel.app/assets/preview.png","button":{"title":"Play","action":{"type":"launch_frame","name":"Minesweeper","url":"https://minesweeper-game-pearl.vercel.app/","splashImageUrl":"https://minesweeper-game-pearl.vercel.app/assets/splash.png","splashBackgroundColor":"#667eea"}}}' />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="üí£ Minesweeper Game" />
  <meta name="twitter:description" content="Can you clear the minefield? Play Minesweeper on Farcaster!" />
  <meta name="twitter:image" content="https://minesweeper-game-pearl.vercel.app/assets/preview.png" />

  <meta name="description" content="Play Minesweeper on Farcaster! Mobile-friendly game with 3 difficulty levels. Share your results and challenge friends." />
  <meta name="keywords" content="minesweeper, farcaster, game, puzzle, mobile, web3" />
  <meta name="author" content="vidhyadar.base.eth" />

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
    import { mintSimpleNFT } from './mint.js'
    window.farcasterSdk = sdk;
    window.mintSimpleNFT = mintSimpleNFT;
  </script>

  <style>
    * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .difficulty-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: 60px;
        }

        .difficulty-btn.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: bold;
        }

        /* Enhanced mode toggle button styling */
        #toggle-mode {
            position: relative;
            overflow: hidden;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #toggle-mode.dig-mode {
            background: rgba(76, 175, 80, 0.8);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        #toggle-mode.flag-mode {
            background: rgba(244, 67, 54, 0.8);
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.3);
        }

        #toggle-mode:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .minefield {
            display: grid;
            gap: 2px;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 0 auto;
            max-width: 100%;
            overflow: auto;
        }

        .cell {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .cell:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }

        .cell.revealed {
            background: rgba(255, 255, 255, 0.6);
            cursor: default;
        }

        .cell.revealed:hover {
            transform: none;
        }

        .cell.flagged {
            background: rgba(255, 100, 100, 0.8);
            color: white;
        }

        .cell.mine {
            background: rgba(255, 0, 0, 0.8);
            color: white;
            animation: explode 0.5s ease-out;
        }

        .cell.false-flag {
            background: rgba(255, 69, 0, 0.9);
            color: white;
            animation: shake 0.5s ease-out;
        }

        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .cell.number-1 { color: #0066cc; }
        .cell.number-2 { color: #009900; }
        .cell.number-3 { color: #ff0000; }
        .cell.number-4 { color: #000080; }
        .cell.number-5 { color: #800000; }
        .cell.number-6 { color: #008080; }
        .cell.number-7 { color: #000000; }
        .cell.number-8 { color: #808080; }

        .game-message {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .game-message.win {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .game-message.lose {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
        }

        .instructions {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            line-height: 1.4;
        }

        .share-section {
            margin-top: 15px;
            text-align: center;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(138, 43, 226, 0.8);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn:hover {
            background: rgba(138, 43, 226, 1);
            transform: translateY(-2px);
        }

        .share-btn.warpcast {
            background: rgba(139, 69, 255, 0.8);
        }

        .share-btn.warpcast:hover {
            background: rgba(139, 69, 255, 1);
        }

        .share-btn.early-adopter-btn {
            background: rgba(255, 193, 7, 0.8);
            font-weight: bold;
        }

        .share-btn.early-adopter-btn:hover {
            background: rgba(255, 193, 7, 1);
            transform: translateY(-2px);
        }

        .early-adopter-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 193, 7, 0.3);
            text-align: center;
            font-size: 0.8rem;
        }

        .nft-stats {
            color: #ffc107;
            font-weight: bold;
        }

        .share-btn.view-nft-btn {
            background: rgba(0, 150, 255, 0.8);
            font-weight: bold;
        }

        .share-btn.view-nft-btn:hover {
            background: rgba(0, 150, 255, 1);
            transform: translateY(-2px);
        }

        /* NFT Viewer Styles */
        .nft-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .nft-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .nft-viewer-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.5rem;
        }

        .close-viewer {
            background: rgba(255, 0, 0, 0.8);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-viewer:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        .nft-viewer-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .player-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .player-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .nft-position {
            font-size: 1.2rem;
            color: #ffc107;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }

        .difficulty-stats {
            margin-bottom: 20px;
        }

        .difficulty-stats h4 {
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
        }

        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .difficulty-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .difficulty-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .difficulty-games, .difficulty-wins {
            font-size: 0.8rem;
            color: #ccc;
        }

        .nft-metadata {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .nft-metadata h4 {
            color: #fff;
            margin-bottom: 10px;
        }

        .metadata-content {
            font-family: monospace;
            font-size: 0.8rem;
            color: #ccc;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .nft-viewer-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .share-nft-btn, .copy-stats-btn, .download-image-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .share-nft-btn {
            background: rgba(139, 69, 255, 0.8);
        }

        .share-nft-btn:hover {
            background: rgba(139, 69, 255, 1);
            transform: translateY(-2px);
        }

        .copy-stats-btn {
            background: rgba(0, 150, 255, 0.8);
        }

        .copy-stats-btn:hover {
            background: rgba(0, 150, 255, 1);
            transform: translateY(-2px);
        }

        .download-image-btn {
            background: rgba(255, 193, 7, 0.8);
        }

        .download-image-btn:hover {
            background: rgba(255, 193, 7, 1);
            transform: translateY(-2px);
        }

        @media (max-width: 480px) {
            .nft-viewer-content {
                padding: 15px;
                margin: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .difficulty-grid {
                grid-template-columns: 1fr;
            }
        }

        .share-result {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 8px;
            color: #00ff88;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 255, 0, 0.3);
            display: none;
        }

        /* Wallet connection section styling */
        .wallet-section {
            margin: 15px 0;
            text-align: center;
        }

        .wallet-btn {
            background: rgba(0, 150, 255, 0.8);
            font-weight: bold;
            min-width: 140px;
        }

        .wallet-btn:hover {
            background: rgba(0, 150, 255, 1);
            transform: translateY(-2px);
        }

        .wallet-btn.connected {
            background: rgba(0, 200, 100, 0.8);
        }

        .wallet-btn.connected:hover {
            background: rgba(0, 200, 100, 1);
        }

        .wallet-status {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-direction: column;
        }

        .wallet-status #wallet-address {
            font-family: monospace;
            color: #00ff88;
            font-weight: bold;
        }

        .chain-indicator {
            font-size: 0.7rem;
            color: #66aaff;
            margin-top: 2px;
        }

        .chain-indicator.base {
            color: #00ff88;
        }

        /* Disabled state for game elements when wallet not connected */
        .game-disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Sound toggle button */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
                margin: 10px;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .cell {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .difficulty-buttons {
                flex-wrap: wrap;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 8px 15px;
            }

            .sound-toggle {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }
  </style>
</head>
<body>
  <!-- Sound toggle button -->
  <button class="sound-toggle" id="sound-toggle">üîä</button>

  <div class="game-container">
    <div class="game-header">
      <h1 class="game-title">üí£ Minesweeper</h1>
    </div>

    <div class="difficulty-buttons">
      <button class="btn difficulty-btn active" data-difficulty="easy">Easy</button>
      <button class="btn difficulty-btn" data-difficulty="medium">Medium</button>
      <button class="btn difficulty-btn" data-difficulty="hard">Hard</button>
    </div>

    <div class="game-stats">
      <div class="stat">
        <span>Mines</span>
        <span class="stat-value" id="mines-count">10</span>
      </div>
      <div class="stat">
        <span>Flags</span>
        <span class="stat-value" id="flags-count">0</span>
      </div>
      <div class="stat">
        <span>Time</span>
        <span class="stat-value" id="timer">0</span>
      </div>
    </div>

    <div class="game-controls">
      <button class="btn" id="new-game">New Game</button>
      <button class="btn dig-mode" id="toggle-mode">üëÜ Reveal Mode</button>
    </div>

    <!-- Wallet Connection Section -->
    <div class="wallet-section" id="wallet-section">
      <button class="btn wallet-btn" id="connect-wallet">üîó Connect Wallet</button>
      <div class="wallet-status" id="wallet-status" style="display: none;">
        <div>
          <span>üë§ Connected: </span>
          <span id="wallet-address"></span>
        </div>
        <div class="chain-indicator" id="chain-indicator">Checking network...</div>
      </div>
    </div>

    <div class="minefield" id="minefield"></div>
    <div class="game-message" id="game-message"></div>

    <div class="share-section">
      <div class="share-result" id="share-result">Link copied to clipboard! üìã</div>
      <div class="share-buttons">
        <button class="share-btn" id="share-warpcast">üü£ Share on Warpcast</button>
        <button class="share-btn" id="share-general">üîó Copy Game Link</button>
        <button class="share-btn" id="share-result-btn" style="display: none;">üèÜ Share Result</button>
        <button class="share-btn early-adopter-btn" id="mint-early-adopter" style="display: none;">‚≠ê Mint NFT (2500 Limit)</button>
        <button class="share-btn view-nft-btn" id="view-my-nft" style="display: none;">üë§ View My NFT</button>
      </div>
      <div class="early-adopter-info" id="early-adopter-info" style="display: none;">
        <div class="nft-stats">
          <span id="nft-count">0/2500</span> Early Adopter NFTs
        </div>
      </div>
      
      <!-- NFT Status Viewer -->
      <div class="nft-viewer" id="nft-viewer" style="display: none;">
        <div class="nft-viewer-header">
          <h3>üéÆ Your Player Status</h3>
          <button class="close-viewer" id="close-nft-viewer">‚úï</button>
        </div>
        <div class="nft-viewer-content">
          <div class="player-info">
            <div class="player-name" id="viewer-player-name">Player Name</div>
            <div class="nft-position" id="viewer-nft-position">NFT #0</div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Games Played</div>
              <div class="stat-value" id="viewer-games-played">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Wins</div>
              <div class="stat-value" id="viewer-wins">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Losses</div>
              <div class="stat-value" id="viewer-losses">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Win Ratio</div>
              <div class="stat-value" id="viewer-win-ratio">0%</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Best Time</div>
              <div class="stat-value" id="viewer-best-time">N/A</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Play Time</div>
              <div class="stat-value" id="viewer-total-time">0s</div>
            </div>
          </div>
          
          <div class="difficulty-stats">
            <h4>Difficulty Breakdown</h4>
            <div class="difficulty-grid">
              <div class="difficulty-card">
                <div class="difficulty-name">Easy</div>
                <div class="difficulty-games" id="viewer-easy-games">0 games</div>
                <div class="difficulty-wins" id="viewer-easy-wins">0 wins</div>
              </div>
              <div class="difficulty-card">
                <div class="difficulty-name">Medium</div>
                <div class="difficulty-games" id="viewer-medium-games">0 games</div>
                <div class="difficulty-wins" id="viewer-medium-wins">0 wins</div>
              </div>
              <div class="difficulty-card">
                <div class="difficulty-name">Hard</div>
                <div class="difficulty-games" id="viewer-hard-games">0 games</div>
                <div class="difficulty-wins" id="viewer-hard-wins">0 wins</div>
              </div>
            </div>
          </div>
          
          <div class="nft-metadata" id="viewer-nft-metadata" style="display: none;">
            <h4>NFT Details</h4>
            <div class="metadata-content" id="viewer-metadata-content"></div>
          </div>
          
          <div class="nft-viewer-actions">
            <button class="share-nft-btn" id="share-nft-status">üü£ Share on Warpcast</button>
            <button class="copy-stats-btn" id="copy-player-stats">üìã Copy Stats</button>
            <button class="download-image-btn" id="download-status-card">üñºÔ∏è Download Image</button>
          </div>
        </div>
      </div>
    </div>

    <div class="instructions">
      <strong>How to play:</strong><br>
      ‚Ä¢ Tap to reveal cells<br>
      ‚Ä¢ Use Flag Mode to mark mines<br>
      ‚Ä¢ Numbers show nearby mines<br>
      ‚Ä¢ Find all mines to win!
    </div>
  </div>

  <script>
    // Global variables for Farcaster wallet
    let walletConnected = false;
    let provider, signer, userAddress, farcasterUser;

    // Connect wallet function with better error handling
    async function connectWallet() {
      if (walletConnected) return true;
      
      // Update button state
      const connectBtn = document.getElementById('connect-wallet');
      connectBtn.textContent = '‚è≥ Connecting...';
      connectBtn.disabled = true;
      
      try {
        // First try MetaMask if available (more reliable)
        if (window.ethereum) {
          console.log("Trying MetaMask connection first...");
          const success = await connectMetaMaskWallet();
          if (success) return true;
        }
        
        // Then try Farcaster if SDK is available
        if (window.farcasterSdk) {
          console.log("Trying Farcaster connection...");
          return await connectFarcasterWallet();
        }
        
        throw new Error("No wallet provider available. Please install MetaMask!");
        
      } catch (err) {
        console.error("‚ùå All wallet connection attempts failed:", err);
        
        // Reset button
        connectBtn.textContent = 'üîó Connect Wallet';
        connectBtn.disabled = false;
        
        if (window.gameInstance) {
          window.gameInstance.showShareResult(`‚ùå Connection failed: ${err.message}`, "error");
        } else {
          alert(`Wallet connection failed: ${err.message}`);
        }
        return false;
      }
    }

    // Farcaster wallet connection
    async function connectFarcasterWallet() {
      try {
        console.log("Available Farcaster SDK methods:", Object.keys(window.farcasterSdk));
        
        // Get user context from Farcaster SDK
        const context = await window.farcasterSdk.context;
        console.log("Farcaster context:", context);
        
        if (!context || !context.user) {
          throw new Error("No Farcaster user context available");
        }
        
        // Store Farcaster user data
        farcasterUser = context.user;
        console.log("Farcaster user:", farcasterUser);
        
        // For Farcaster, we'll use the embedded wallet or MetaMask
        if (window.ethereum) {
          // Switch to Base chain if not already on it
          await switchToBaseChain();
          
          provider = new ethers.providers.Web3Provider(window.ethereum);
          const accounts = await provider.send("eth_requestAccounts", []);
          
          if (!accounts || accounts.length === 0) {
            throw new Error("No accounts found");
          }
          
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          
          console.log("‚úÖ Wallet connected via Farcaster context");
          
          // Request signature for authentication
          const message = `Sign in to Minesweeper Game\nAddress: ${userAddress}\nTime: ${new Date().toISOString()}`;
          const signature = await signer.signMessage(message);
          console.log("‚úÖ Message signed successfully");
          
        walletConnected = true;
        await updateWalletUI();
        
        if (window.gameInstance) {
          window.gameInstance.showShareResult(`üéâ Farcaster wallet connected! Welcome ${farcasterUser.displayName || farcasterUser.username || 'User'}!`, "success");
          window.gameInstance.enableGame();
          await window.gameInstance.updateEarlyAdopterUI();
        }
          
          return true;
        } else {
          throw new Error("No ethereum provider available");
        }
        
      } catch (err) {
        console.error("Farcaster connection failed:", err);
        throw err;
      }
    }

    // Switch to Base Sepolia testnet
    async function switchToBaseChain() {
      try {
        const baseChainId = '0x14a34'; // 84532 in hex (Base Sepolia testnet)
        const baseChainConfig = {
          chainId: baseChainId,
          chainName: 'Base Sepolia',
          rpcUrls: ['https://sepolia.base.org'],
          nativeCurrency: {
            name: 'Ethereum',
            symbol: 'ETH',
            decimals: 18
          },
          blockExplorerUrls: ['https://sepolia.basescan.org']
        };

        try {
          // Try to switch to Base chain
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: baseChainId }],
          });
          console.log("‚úÖ Switched to Base Sepolia testnet");
        } catch (switchError) {
          // If the chain doesn't exist, add it
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [baseChainConfig],
              });
              console.log("‚úÖ Added and switched to Base Sepolia testnet");
            } catch (addError) {
              throw new Error("Failed to add Base Sepolia testnet: " + addError.message);
            }
          } else {
            throw new Error("Failed to switch to Base Sepolia testnet: " + switchError.message);
          }
        }
      } catch (err) {
        console.error("Base chain switch failed:", err);
        throw new Error("Please switch to Base Sepolia testnet manually in your wallet");
      }
    }

    // MetaMask connection with signature
    async function connectMetaMaskWallet() {
      try {
        if (!window.ethereum) {
          throw new Error("MetaMask not installed");
        }
        
        console.log("Connecting to MetaMask...");
        
        // Switch to Base chain first
        await switchToBaseChain();
        
        provider = new ethers.providers.Web3Provider(window.ethereum);
        
        // Request account access
        const accounts = await provider.send("eth_requestAccounts", []);
        if (!accounts || accounts.length === 0) {
          throw new Error("No accounts found in MetaMask");
        }
        
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        console.log("MetaMask connected, address:", userAddress);
        
        // Request signature for authentication
        const message = `Sign in to Minesweeper Game\nAddress: ${userAddress}\nTime: ${new Date().toISOString()}`;
        
        try {
          const signature = await signer.signMessage(message);
          console.log("‚úÖ MetaMask message signed successfully");
          
          walletConnected = true;
          await updateWalletUI();
          
          if (window.gameInstance) {
            window.gameInstance.showShareResult(`ü¶ä MetaMask connected successfully on Base!`, "success");
            window.gameInstance.enableGame();
            await window.gameInstance.updateEarlyAdopterUI();
          }
          
          return true;
          
        } catch (signError) {
          if (signError.code === 4001) {
            throw new Error("Please sign the message to authenticate");
          } else {
            throw new Error("Signature failed: " + signError.message);
          }
        }
        
      } catch (err) {
        console.error("MetaMask connection failed:", err);
        if (err.code === 4001) {
          throw new Error("Please connect your MetaMask wallet");
        } else if (err.code === -32002) {
          throw new Error("MetaMask connection request pending. Please check MetaMask.");
        } else {
          throw err;
        }
      }
    }

    // Update wallet UI
    async function updateWalletUI() {
      const connectBtn = document.getElementById('connect-wallet');
      const walletStatus = document.getElementById('wallet-status');
      const walletAddress = document.getElementById('wallet-address');
      const chainIndicator = document.getElementById('chain-indicator');
      
      if (walletConnected && userAddress) {
        connectBtn.textContent = '‚úÖ Connected';
        connectBtn.classList.add('connected');
        connectBtn.disabled = false;
        
        walletStatus.style.display = 'flex';
        walletAddress.textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;
        
        // Update chain indicator
        try {
          if (provider) {
            const network = await provider.getNetwork();
            if (network.chainId === 84532) {
              chainIndicator.textContent = 'üîó Base Sepolia';
              chainIndicator.classList.add('base');
            } else {
              chainIndicator.textContent = `‚ö†Ô∏è Chain ID: ${network.chainId}`;
              chainIndicator.classList.remove('base');
            }
          } else {
            chainIndicator.textContent = '‚ùì Unknown Network';
          }
        } catch (err) {
          chainIndicator.textContent = '‚ùå Network Error';
        }
        
        // Enable game elements
        document.querySelectorAll('.difficulty-btn, #new-game, #toggle-mode').forEach(el => {
          el.classList.remove('game-disabled');
        });
        document.getElementById('minefield').classList.remove('game-disabled');
        
        // Update early adopter UI
        if (window.gameInstance) {
          await window.gameInstance.updateEarlyAdopterUI();
        }
        
      } else {
        connectBtn.textContent = 'üîó Connect Wallet';
        connectBtn.classList.remove('connected');
        connectBtn.disabled = false;
        
        walletStatus.style.display = 'none';
        
        // Disable game elements
        document.querySelectorAll('.difficulty-btn, #new-game, #toggle-mode').forEach(el => {
          el.classList.add('game-disabled');
        });
        document.getElementById('minefield').classList.add('game-disabled');
      }
    }

    // Early Adopter NFT minting system with player statistics
    let earlyAdopterNFTs = {
      totalMinted: 0,
      maxSupply: 2500,
      playerNFTs: new Map(), // Track NFTs per player
      playerStats: new Map(), // Track detailed player statistics
      isEarlyAdopter: function() {
        return this.totalMinted < this.maxSupply;
      },
      canPlayerMint: function(playerAddress) {
        // Allow one NFT per player for early adopters
        return this.isEarlyAdopter() && !this.playerNFTs.has(playerAddress);
      },
      // Initialize or get player stats
      getPlayerStats: function(playerAddress) {
        if (!this.playerStats.has(playerAddress)) {
          this.playerStats.set(playerAddress, {
            gamesPlayed: 0,
            wins: 0,
            losses: 0,
            winRatio: 0,
            bestTime: null,
            totalPlayTime: 0,
            difficultyStats: {
              easy: { games: 0, wins: 0 },
              medium: { games: 0, wins: 0 },
              hard: { games: 0, wins: 0 }
            }
          });
        }
        return this.playerStats.get(playerAddress);
      },
      // Update player stats after game completion
      updatePlayerStats: function(playerAddress, gameResult) {
        const stats = this.getPlayerStats(playerAddress);
        stats.gamesPlayed++;
        
        if (gameResult.win) {
          stats.wins++;
          if (!stats.bestTime || gameResult.time < stats.bestTime) {
            stats.bestTime = gameResult.time;
          }
        } else {
          stats.losses++;
        }
        
        stats.totalPlayTime += gameResult.time;
        stats.winRatio = stats.gamesPlayed > 0 ? (stats.wins / stats.gamesPlayed * 100).toFixed(1) : 0;
        
        // Update difficulty stats
        if (stats.difficultyStats[gameResult.difficulty]) {
          stats.difficultyStats[gameResult.difficulty].games++;
          if (gameResult.win) {
            stats.difficultyStats[gameResult.difficulty].wins++;
          }
        }
        
        this.playerStats.set(playerAddress, stats);
        return stats;
      }
    };

    // Early adopter NFT minting function is now imported from mint.js
    // async function mintEarlyAdopterNFT(playerAddress, playerName) {
      // try {
      //   // Check if player can mint
      //   if (!earlyAdopterNFTs.canPlayerMint(playerAddress)) {
      //     if (!earlyAdopterNFTs.isEarlyAdopter()) {
      //       throw new Error("Early adopter period ended. All 2,500 NFTs have been minted!");
      //     } else {
      //       throw new Error("You already have an early adopter NFT!");
      //     }
      //   }

      //   // Check if we're on Base chain
      //   const network = await provider.getNetwork();
      //   if (network.chainId !== 8453) {
      //     throw new Error("Please switch to Base chain to mint NFTs");
      //   }

      // Function body removed - now using real contract from mint.js
    

    // Check if player is eligible for early adopter NFT
    function checkEarlyAdopterEligibility(playerAddress) {
      return {
        isEligible: earlyAdopterNFTs.canPlayerMint(playerAddress),
        hasNFT: earlyAdopterNFTs.playerNFTs.has(playerAddress),
        totalMinted: earlyAdopterNFTs.totalMinted,
        maxSupply: earlyAdopterNFTs.maxSupply,
        remaining: earlyAdopterNFTs.maxSupply - earlyAdopterNFTs.totalMinted
      };
    }

    // Minesweeper Game Class
    class Minesweeper {
      constructor() {
        this.gameState = 'ready';
        this.flagMode = false;
        this.firstClick = true;
        this.timer = 0;
        this.timerInterval = null;
        this.soundEnabled = true;

        this.difficulties = {
          easy: { rows: 9, cols: 9, mines: 10 },
          medium: { rows: 12, cols: 12, mines: 20 },
          hard: { rows: 15, cols: 15, mines: 35 }
        };

        this.currentDifficulty = 'easy';
        this.config = this.difficulties.easy;
        this.board = [];
        this.revealed = [];
        this.flagged = [];

        this.createSounds();
        this.initializeGame();
        this.setupEventListeners();
      }

      createSounds() {
        // Create sound effects using Web Audio API
        this.audioContext = null;
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log('Audio not supported');
        }
      }

      playSound(frequency = 440, duration = 200, type = 'sine') {
        if (!this.soundEnabled || !this.audioContext) return;

        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = type;

        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration / 1000);

        oscillator.start(this.audioContext.currentTime);
        oscillator.stop(this.audioContext.currentTime + duration / 1000);
      }

      initializeGame() {
        this.gameState = 'ready';
        this.firstClick = true;
        this.timer = 0;
        this.clearTimer();
        
        this.config = this.difficulties[this.currentDifficulty];
        this.board = [];
        this.revealed = [];
        this.flagged = [];

        // Initialize empty board
        for (let i = 0; i < this.config.rows; i++) {
          this.board[i] = [];
          this.revealed[i] = [];
          this.flagged[i] = [];
          for (let j = 0; j < this.config.cols; j++) {
            this.board[i][j] = 0;
            this.revealed[i][j] = false;
            this.flagged[i][j] = false;
          }
        }

        this.updateDisplay();
        this.renderBoard();
        document.getElementById('game-message').textContent = '';
        document.getElementById('share-result-btn').style.display = 'none';
      }

      placeMines(excludeRow, excludeCol) {
        let minesPlaced = 0;
        while (minesPlaced < this.config.mines) {
          const row = Math.floor(Math.random() * this.config.rows);
          const col = Math.floor(Math.random() * this.config.cols);
          
          // Don't place mine on first click or if already has mine
          if ((row === excludeRow && col === excludeCol) || this.board[row][col] === -1) {
            continue;
          }
          
          this.board[row][col] = -1; // -1 represents a mine
          minesPlaced++;
        }

        // Calculate numbers for each cell
        for (let i = 0; i < this.config.rows; i++) {
          for (let j = 0; j < this.config.cols; j++) {
            if (this.board[i][j] !== -1) {
              this.board[i][j] = this.countAdjacentMines(i, j);
            }
          }
        }
      }

      countAdjacentMines(row, col) {
        let count = 0;
        for (let i = -1; i <= 1; i++) {
          for (let j = -1; j <= 1; j++) {
            const newRow = row + i;
            const newCol = col + j;
            if (newRow >= 0 && newRow < this.config.rows && 
                newCol >= 0 && newCol < this.config.cols && 
                this.board[newRow][newCol] === -1) {
              count++;
            }
          }
        }
        return count;
      }

      renderBoard() {
        const minefield = document.getElementById('minefield');
        minefield.innerHTML = '';
        minefield.style.gridTemplateColumns = `repeat(${this.config.cols}, 32px)`;
        minefield.style.gridTemplateRows = `repeat(${this.config.rows}, 32px)`;

        for (let i = 0; i < this.config.rows; i++) {
          for (let j = 0; j < this.config.cols; j++) {
            const cell = document.createElement('button');
            cell.className = 'cell';
            cell.dataset.row = i;
            cell.dataset.col = j;
            
            cell.addEventListener('click', (e) => {
              e.preventDefault();
              this.handleCellClick(i, j);
            });

            minefield.appendChild(cell);
          }
        }

        this.updateBoard();
      }

      updateBoard() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(cell => {
          const row = parseInt(cell.dataset.row);
          const col = parseInt(cell.dataset.col);
          
          cell.className = 'cell';
          cell.textContent = '';

          if (this.flagged[row][col]) {
            cell.classList.add('flagged');
            cell.textContent = 'üö©';
          } else if (this.revealed[row][col]) {
            cell.classList.add('revealed');
            if (this.board[row][col] === -1) {
              cell.classList.add('mine');
              cell.textContent = 'üí£';
            } else if (this.board[row][col] > 0) {
              cell.textContent = this.board[row][col];
              cell.classList.add(`number-${this.board[row][col]}`);
            }
          }
        });
      }

      async handleCellClick(row, col) {
        // Check if wallet is connected before allowing any gameplay
        if (!walletConnected) {
          this.showShareResult('Please connect your wallet first! üîó', 'error');
          return;
        }

        if (this.gameState !== 'ready' && this.gameState !== 'playing') return;
        if (this.revealed[row][col]) return;

        if (this.flagMode) {
          this.toggleFlag(row, col);
          return;
        }

        // First click - place mines
        if (this.firstClick) {
          this.placeMines(row, col);
          this.firstClick = false;
          this.gameState = 'playing';
          this.startTimer();
        }

        if (this.flagged[row][col]) return;

        this.revealCell(row, col);
        this.playSound(800, 100);

        if (this.board[row][col] === -1) {
          this.gameOver(false);
        } else if (this.checkWin()) {
          this.gameOver(true);
        }

        this.updateBoard();
        this.updateDisplay();
      }

      revealCell(row, col) {
        if (row < 0 || row >= this.config.rows || col < 0 || col >= this.config.cols) return;
        if (this.revealed[row][col] || this.flagged[row][col]) return;

        this.revealed[row][col] = true;

        // Auto-reveal adjacent cells if this cell has no adjacent mines
        if (this.board[row][col] === 0) {
          for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
              this.revealCell(row + i, col + j);
            }
          }
        }
      }

      toggleFlag(row, col) {
        if (this.revealed[row][col]) return;

        this.flagged[row][col] = !this.flagged[row][col];
        this.playSound(600, 150);
        this.updateBoard();
        this.updateDisplay();
      }

      checkWin() {
        for (let i = 0; i < this.config.rows; i++) {
          for (let j = 0; j < this.config.cols; j++) {
            if (this.board[i][j] !== -1 && !this.revealed[i][j]) {
              return false;
            }
          }
        }
        return true;
      }

      gameOver(won) {
        this.gameState = won ? 'won' : 'lost';
        this.clearTimer();

        // Update player statistics if wallet is connected
        if (walletConnected && userAddress) {
          const gameResult = {
            difficulty: this.currentDifficulty,
            time: this.timer,
            win: won
          };
          earlyAdopterNFTs.updatePlayerStats(userAddress, gameResult);
        }

        if (won) {
          this.playSound(880, 500, 'triangle');
          document.getElementById('game-message').textContent = 'üéâ You won!';
          document.getElementById('game-message').className = 'game-message win';
        } else {
          this.playSound(220, 800, 'sawtooth');
          document.getElementById('game-message').textContent = 'üí• Game over!';
          document.getElementById('game-message').className = 'game-message lose';
          
          // Reveal all mines
          for (let i = 0; i < this.config.rows; i++) {
            for (let j = 0; j < this.config.cols; j++) {
              if (this.board[i][j] === -1) {
                this.revealed[i][j] = true;
              }
              if (this.flagged[i][j] && this.board[i][j] !== -1) {
                document.querySelector(`[data-row="${i}"][data-col="${j}"]`).classList.add('false-flag');
              }
            }
          }
        }

        document.getElementById('share-result-btn').style.display = 'inline-flex';
        this.updateBoard();
      }

      startTimer() {
        this.timerInterval = setInterval(() => {
          this.timer++;
          document.getElementById('timer').textContent = this.timer;
        }, 1000);
      }

      clearTimer() {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
          this.timerInterval = null;
        }
      }

      updateDisplay() {
        document.getElementById('mines-count').textContent = this.config.mines;
        
        const flagCount = this.flagged.flat().filter(Boolean).length;
        document.getElementById('flags-count').textContent = flagCount;
        document.getElementById('timer').textContent = this.timer;
      }

      toggleMode() {
        this.flagMode = !this.flagMode;
        const button = document.getElementById('toggle-mode');
        
        if (this.flagMode) {
          button.textContent = 'üö© Flag Mode';
          button.className = 'btn flag-mode';
        } else {
          button.textContent = 'üëÜ Reveal Mode';
          button.className = 'btn dig-mode';
        }
      }

      changeDifficulty(difficulty) {
        if (this.gameState === 'playing') {
          if (!confirm('This will start a new game. Continue?')) return;
        }

        this.currentDifficulty = difficulty;
        
        // Update active button
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('active');
        
        this.initializeGame();
      }

      shareToWarpcast() {
        const gameUrl = window.location.href;
        const text = encodeURIComponent('üéÆ Playing Minesweeper! Can you beat my score?');
        const warpcastUrl = `https://warpcast.com/~/compose?text=${text}&embeds[]=${encodeURIComponent(gameUrl)}`;
        window.open(warpcastUrl, '_blank');
      }

      copyGameLink() {
        const gameUrl = window.location.href;
        navigator.clipboard.writeText(gameUrl).then(() => {
          this.showShareResult('Game link copied to clipboard! üìã');
        }).catch(() => {
          this.showShareResult('Failed to copy link. Try again!', 'error');
        });
      }

      shareResult() {
        const result = this.gameState === 'won' ? 'Won' : 'Lost';
        const text = `üéÆ Minesweeper Result: ${result}!\nDifficulty: ${this.currentDifficulty}\nTime: ${this.timer}s\n\nPlay here: ${window.location.href}`;
        
        if (navigator.share) {
          navigator.share({
            title: 'Minesweeper Game Result',
            text: text,
            url: window.location.href
          });
        } else {
          navigator.clipboard.writeText(text).then(() => {
            this.showShareResult('Result copied to clipboard! üìã');
          }).catch(() => {
            this.showShareResult('Failed to copy result. Try again!', 'error');
          });
        }
      }

      showShareResult(message, type = 'success') {
        const shareResult = document.getElementById('share-result');
        shareResult.textContent = message;
        shareResult.style.display = 'block';
        
        // Update styling based on type
        shareResult.style.background = type === 'error' ? 'rgba(255, 0, 0, 0.1)' : 
                                      type === 'info' ? 'rgba(0, 100, 255, 0.1)' :
                                      'rgba(0, 255, 0, 0.1)';
        shareResult.style.color = type === 'error' ? '#ff6666' : 
                                 type === 'info' ? '#66aaff' :
                                 '#00ff88';
        shareResult.style.borderColor = type === 'error' ? 'rgba(255, 0, 0, 0.3)' : 
                                       type === 'info' ? 'rgba(0, 100, 255, 0.3)' :
                                       'rgba(0, 255, 0, 0.3)';
        
        setTimeout(() => {
          shareResult.style.display = 'none';
        }, 3000);
      }

      setupEventListeners() {
        // Connect Wallet button
        document.getElementById('connect-wallet').addEventListener('click', async () => {
          await connectWallet();
        });

        // New Game button - requires wallet connection
        document.getElementById('new-game').addEventListener('click', async () => {
          if (!walletConnected) {
            this.showShareResult('Please connect your wallet first! üîó', 'error');
            return;
          }
          this.initializeGame();
        });

        // Mode toggle
        document.getElementById('toggle-mode').addEventListener('click', () => {
          if (!walletConnected) {
            this.showShareResult('Please connect your wallet first! üîó', 'error');
            return;
          }
          this.toggleMode();
        });

        // Difficulty buttons
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            if (!walletConnected) {
              this.showShareResult('Please connect your wallet first! üîó', 'error');
              return;
            }
            this.changeDifficulty(e.target.dataset.difficulty);
          });
        });

        // Sound toggle
        document.getElementById('sound-toggle').addEventListener('click', () => {
          this.soundEnabled = !this.soundEnabled;
          document.getElementById('sound-toggle').textContent = this.soundEnabled ? 'üîä' : 'üîá';
        });

        // Share buttons
        document.getElementById('share-warpcast').addEventListener('click', () => {
          this.shareToWarpcast();
        });

        document.getElementById('share-general').addEventListener('click', () => {
          this.copyGameLink();
        });

        // Share result button (no minting)
        document.getElementById('share-result-btn').addEventListener('click', async () => {
          if (this.gameState === 'ready' || this.gameState === 'playing') {
            this.showShareResult('Finish the game first! üéÆ', 'error');
            return;
          }

          // Check if wallet is connected
          if (!walletConnected) {
            this.showShareResult('Please connect your wallet first! üîó', 'error');
            return;
          }

          // Just share the result without minting
          this.shareResult();
        });

        // Early adopter NFT minting button
        document.getElementById('mint-early-adopter').addEventListener('click', async () => {
          if (!walletConnected) {
            this.showShareResult('Please connect your wallet first! üîó', 'error');
            return;
          }

          try {
            const playerName = farcasterUser?.displayName || farcasterUser?.username || 'Anonymous';
            const eligibility = checkEarlyAdopterEligibility(userAddress);
            
            if (!eligibility.isEligible) {
              if (eligibility.hasNFT) {
                this.showShareResult('You already have an Early Adopter NFT! ‚≠ê', 'info');
              } else {
                this.showShareResult('Early adopter period ended! All 2,500 NFTs have been minted. üò¢', 'error');
              }
              return;
            }

            const confirmMint = confirm(
              `Mint Simple NFT?\n\n` +
              `Player: ${playerName}\n` +
              `NFT #${eligibility.totalMinted + 1} of 2,500\n` +
              `Remaining: ${eligibility.remaining}\n\n` +
              `This will mint a simple NFT with 2500 total supply limit.`
            );

            if (confirmMint) {
              const result = await mintSimpleNFT(userAddress);
              await this.updateEarlyAdopterUI();
              this.showShareResult(`üéâ NFT #${result.tokenId} minted! ${result.remaining} remaining.`, 'success');
            }
          } catch (err) {
            console.error('Early adopter minting failed:', err);
            this.showShareResult(`‚ùå ${err.message}`, 'error');
          }
        });

        // View My NFT button
        document.getElementById('view-my-nft').addEventListener('click', () => {
          this.showNFTViewer();
        });


        // Close NFT viewer
        document.getElementById('close-nft-viewer').addEventListener('click', () => {
          this.hideNFTViewer();
        });

        // Close NFT viewer when clicking outside
        document.getElementById('nft-viewer').addEventListener('click', (e) => {
          if (e.target.id === 'nft-viewer') {
            this.hideNFTViewer();
          }
        });

        // Share NFT status on Warpcast
        document.getElementById('share-nft-status').addEventListener('click', () => {
          this.shareNFTStatusToWarpcast();
        });

        // Copy player stats
        document.getElementById('copy-player-stats').addEventListener('click', () => {
          this.copyPlayerStats();
        });

        // Download status card image
        document.getElementById('download-status-card').addEventListener('click', () => {
          this.downloadStatusCard();
        });
      }

      // Enable game after wallet connection
      enableGame() {
        document.querySelectorAll('.difficulty-btn, #new-game, #toggle-mode').forEach(el => {
          el.classList.remove('game-disabled');
        });
        document.getElementById('minefield').classList.remove('game-disabled');
      }

      // Disable game when wallet not connected
      disableGame() {
        document.querySelectorAll('.difficulty-btn, #new-game, #toggle-mode').forEach(el => {
          el.classList.add('game-disabled');
        });
        document.getElementById('minefield').classList.add('game-disabled');
      }

      // Get contract data (total minted, remaining supply)
      async getContractData() {
        try {
          if (!window.ethereum) {
            throw new Error("No ethereum provider");
          }
          
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const network = await provider.getNetwork();
          
          if (network.chainId !== 84532) { // Base Sepolia testnet
            throw new Error("Please switch to Base Sepolia testnet");
          }
          
          const signer = provider.getSigner();
          
          // Contract configuration
          const CONTRACT_ADDRESS = "0xB2e0357A94a555B5BB6A3dC0A5c90F18FFCBd778";
          const CONTRACT_ABI = [
            {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"remainingSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
          ];
          
          const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
          
          // Test contract connection
          try {
            await contract.name();
          } catch (err) {
            console.error('Contract not found or not deployed at this address:', err);
            throw new Error('Contract not found or not deployed at this address');
          }
          
          const [totalMinted, remainingSupply, maxSupply] = await Promise.all([
            contract.totalSupply(),
            contract.remainingSupply(),
            contract.MAX_SUPPLY()
          ]);
          
          
          return {
            totalMinted: Number(totalMinted),
            remaining: Number(remainingSupply),
            maxSupply: Number(maxSupply)
          };
        } catch (err) {
          console.error('Failed to fetch contract data:', err);
          // Return fallback data
          return {
            totalMinted: earlyAdopterNFTs.totalMinted,
            remaining: earlyAdopterNFTs.maxSupply - earlyAdopterNFTs.totalMinted,
            maxSupply: earlyAdopterNFTs.maxSupply
          };
        }
      }

      // Update early adopter UI
      async updateEarlyAdopterUI() {
        const mintButton = document.getElementById('mint-early-adopter');
        const viewButton = document.getElementById('view-my-nft');
        const infoDiv = document.getElementById('early-adopter-info');
        const nftCount = document.getElementById('nft-count');
        
        if (walletConnected && userAddress) {
          try {
            // Fetch real contract data
            const contractData = await this.getContractData();
            const eligibility = checkEarlyAdopterEligibility(userAddress);
            
            // Update the local totalMinted with real contract data
            earlyAdopterNFTs.totalMinted = contractData.totalMinted;
            
            // Show/hide mint button based on eligibility
            if (eligibility.isEligible) {
              mintButton.style.display = 'inline-flex';
              mintButton.textContent = `‚≠ê Mint NFT (${contractData.remaining} left)`;
              viewButton.style.display = 'none';
            } else {
              mintButton.style.display = 'none';
              // Show view button if player has NFT or has played games
              const playerStats = earlyAdopterNFTs.getPlayerStats(userAddress);
              if (eligibility.hasNFT || playerStats.gamesPlayed > 0) {
                viewButton.style.display = 'inline-flex';
              } else {
                viewButton.style.display = 'none';
              }
            }
            
            // Show NFT stats with real data
            infoDiv.style.display = 'block';
            nftCount.textContent = `${contractData.totalMinted}/${contractData.maxSupply}`;
            
            // Update button text if player already has NFT
            if (eligibility.hasNFT) {
              mintButton.style.display = 'inline-flex';
              mintButton.textContent = '‚≠ê You have an NFT!';
              mintButton.disabled = true;
              viewButton.style.display = 'inline-flex';
            }
          } catch (err) {
            console.error('Failed to update early adopter UI:', err);
            // Fallback to local data
            const eligibility = checkEarlyAdopterEligibility(userAddress);
            infoDiv.style.display = 'block';
            nftCount.textContent = `${eligibility.totalMinted}/${eligibility.maxSupply}`;
          }
        } else {
          mintButton.style.display = 'none';
          viewButton.style.display = 'none';
          infoDiv.style.display = 'none';
        }
      }

      // Show NFT viewer with player data
      showNFTViewer() {
        if (!walletConnected || !userAddress) {
          this.showShareResult('Please connect your wallet first! üîó', 'error');
          return;
        }

        const playerStats = earlyAdopterNFTs.getPlayerStats(userAddress);
        const playerName = farcasterUser?.displayName || farcasterUser?.username || 'Anonymous';
        const eligibility = checkEarlyAdopterEligibility(userAddress);
        
        // Update player info
        document.getElementById('viewer-player-name').textContent = playerName;
        document.getElementById('viewer-nft-position').textContent = eligibility.hasNFT ? 
          `NFT #${earlyAdopterNFTs.playerNFTs.get(userAddress)?.mintNumber || 'Unknown'}` : 
          'No NFT yet';

        // Update stats
        document.getElementById('viewer-games-played').textContent = playerStats.gamesPlayed;
        document.getElementById('viewer-wins').textContent = playerStats.wins;
        document.getElementById('viewer-losses').textContent = playerStats.losses;
        document.getElementById('viewer-win-ratio').textContent = `${playerStats.winRatio}%`;
        document.getElementById('viewer-best-time').textContent = playerStats.bestTime ? `${playerStats.bestTime}s` : 'N/A';
        document.getElementById('viewer-total-time').textContent = `${playerStats.totalPlayTime}s`;

        // Update difficulty stats
        document.getElementById('viewer-easy-games').textContent = `${playerStats.difficultyStats.easy.games} games`;
        document.getElementById('viewer-easy-wins').textContent = `${playerStats.difficultyStats.easy.wins} wins`;
        document.getElementById('viewer-medium-games').textContent = `${playerStats.difficultyStats.medium.games} games`;
        document.getElementById('viewer-medium-wins').textContent = `${playerStats.difficultyStats.medium.wins} wins`;
        document.getElementById('viewer-hard-games').textContent = `${playerStats.difficultyStats.hard.games} games`;
        document.getElementById('viewer-hard-wins').textContent = `${playerStats.difficultyStats.hard.wins} wins`;

        // Show NFT metadata if player has NFT
        if (eligibility.hasNFT) {
          const nftData = earlyAdopterNFTs.playerNFTs.get(userAddress);
          if (nftData) {
            document.getElementById('viewer-nft-metadata').style.display = 'block';
            document.getElementById('viewer-metadata-content').textContent = JSON.stringify({
              mintPosition: nftData.mintNumber,
              txHash: nftData.txHash,
              timestamp: new Date(nftData.timestamp).toISOString(),
              playerStats: playerStats
            }, null, 2);
          }
        } else {
          document.getElementById('viewer-nft-metadata').style.display = 'none';
        }

        // Show the viewer
        document.getElementById('nft-viewer').style.display = 'flex';
      }

      // Hide NFT viewer
      hideNFTViewer() {
        document.getElementById('nft-viewer').style.display = 'none';
      }

      // Share NFT status to Warpcast
      async shareNFTStatusToWarpcast() {
        if (!walletConnected || !userAddress) {
          this.showShareResult('Please connect your wallet first! üîó', 'error');
          return;
        }

        try {
          this.showShareResult('üé® Creating your status card...', 'info');
          
          // Generate the status card image
          const imageDataUrl = await this.generatePlayerStatusCard();
          
          // Create share text with image
          const playerStats = earlyAdopterNFTs.getPlayerStats(userAddress);
          const playerName = farcasterUser?.displayName || farcasterUser?.username || 'Anonymous';
          const eligibility = checkEarlyAdopterEligibility(userAddress);
          
          let shareText = `üéÆ Minesweeper Player Status\n\n`;
          shareText += `üë§ Player: ${playerName}\n`;
          
          if (eligibility.hasNFT) {
            const nftData = earlyAdopterNFTs.playerNFTs.get(userAddress);
            shareText += `‚≠ê Early Adopter NFT #${nftData?.mintNumber || 'Unknown'}\n\n`;
          } else {
            shareText += `üéØ Building my stats...\n\n`;
          }
          
          shareText += `üìä Games: ${playerStats.gamesPlayed} | Wins: ${playerStats.wins} | Win Rate: ${playerStats.winRatio}%\n`;
          shareText += `üí£ Play Minesweeper on Farcaster!\n`;
          shareText += `üîó ${window.location.href}`;
          
          // Open Warpcast with the share text
          const warpcastUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(shareText)}`;
          window.open(warpcastUrl, '_blank');
          
          this.showShareResult('Opening Warpcast to share your status! üü£', 'success');
          
        } catch (error) {
          console.error('Error generating status card:', error);
          this.showShareResult('Error creating status card. Please try again.', 'error');
        }
      }

      // Generate player status card as image
      async generatePlayerStatusCard() {
        const playerStats = earlyAdopterNFTs.getPlayerStats(userAddress);
        const playerName = farcasterUser?.displayName || farcasterUser?.username || 'Anonymous';
        const eligibility = checkEarlyAdopterEligibility(userAddress);
        
        // Create canvas
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size
        canvas.width = 800;
        canvas.height = 600;
        
        // Background gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 600);
        gradient.addColorStop(0, '#667eea');
        gradient.addColorStop(1, '#764ba2');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 800, 600);
        
        // Add overlay for better text readability
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(0, 0, 800, 600);
        
        // Title
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 36px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('üéÆ Minesweeper Player Status', 400, 60);
        
        // Player info
        ctx.font = 'bold 24px Arial';
        ctx.fillText(`üë§ ${playerName}`, 400, 100);
        
        // NFT status
        if (eligibility.hasNFT) {
          const nftData = earlyAdopterNFTs.playerNFTs.get(userAddress);
          ctx.fillStyle = '#ffc107';
          ctx.font = 'bold 20px Arial';
          ctx.fillText(`‚≠ê Early Adopter NFT #${nftData?.mintNumber || 'Unknown'}`, 400, 130);
        } else {
          ctx.fillStyle = '#00ff88';
          ctx.font = 'bold 20px Arial';
          ctx.fillText('üéØ Building my stats...', 400, 130);
        }
        
        // Stats section
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'left';
        ctx.fillText('üìä Game Statistics', 50, 180);
        
        // Stats grid
        const stats = [
          { label: 'Games Played', value: playerStats.gamesPlayed },
          { label: 'Wins', value: playerStats.wins },
          { label: 'Losses', value: playerStats.losses },
          { label: 'Win Rate', value: `${playerStats.winRatio}%` },
          { label: 'Best Time', value: playerStats.bestTime ? `${playerStats.bestTime}s` : 'N/A' },
          { label: 'Total Play Time', value: `${playerStats.totalPlayTime}s` }
        ];
        
        ctx.font = '16px Arial';
        let yPos = 220;
        stats.forEach((stat, index) => {
          const x = 50 + (index % 2) * 350;
          const y = yPos + Math.floor(index / 2) * 30;
          ctx.fillText(`${stat.label}: ${stat.value}`, x, y);
        });
        
        // Difficulty breakdown
        ctx.font = 'bold 18px Arial';
        ctx.fillText('üéØ Difficulty Breakdown', 50, 380);
        
        ctx.font = '16px Arial';
        const difficulties = [
          { name: 'Easy', stats: playerStats.difficultyStats.easy },
          { name: 'Medium', stats: playerStats.difficultyStats.medium },
          { name: 'Hard', stats: playerStats.difficultyStats.hard }
        ];
        
        difficulties.forEach((diff, index) => {
          const x = 50 + index * 200;
          const y = 420;
          ctx.fillText(`${diff.name}:`, x, y);
          ctx.fillText(`${diff.stats.games} games`, x, y + 20);
          ctx.fillText(`${diff.stats.wins} wins`, x, y + 40);
        });
        
        // Footer
        ctx.fillStyle = '#ffc107';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('üí£ Play Minesweeper on Farcaster!', 400, 550);
        
        // Convert canvas to image
        return canvas.toDataURL('image/png');
      }

      // Copy player stats to clipboard
      copyPlayerStats() {
        if (!walletConnected || !userAddress) {
          this.showShareResult('Please connect your wallet first! üîó', 'error');
          return;
        }

        const playerStats = earlyAdopterNFTs.getPlayerStats(userAddress);
        const playerName = farcasterUser?.displayName || farcasterUser?.username || 'Anonymous';
        const eligibility = checkEarlyAdopterEligibility(userAddress);
        
        // Create formatted stats text
        let statsText = `üéÆ Minesweeper Player Status\n\n`;
        statsText += `üë§ Player: ${playerName}\n`;
        
        if (eligibility.hasNFT) {
          const nftData = earlyAdopterNFTs.playerNFTs.get(userAddress);
          statsText += `‚≠ê Early Adopter NFT #${nftData?.mintNumber || 'Unknown'}\n\n`;
        }
        
        statsText += `üìä Game Statistics:\n`;
        statsText += `‚Ä¢ Games Played: ${playerStats.gamesPlayed}\n`;
        statsText += `‚Ä¢ Wins: ${playerStats.wins}\n`;
        statsText += `‚Ä¢ Losses: ${playerStats.losses}\n`;
        statsText += `‚Ä¢ Win Rate: ${playerStats.winRatio}%\n`;
        statsText += `‚Ä¢ Best Time: ${playerStats.bestTime ? playerStats.bestTime + 's' : 'N/A'}\n`;
        statsText += `‚Ä¢ Total Play Time: ${playerStats.totalPlayTime}s\n\n`;
        
        statsText += `üéØ Difficulty Breakdown:\n`;
        statsText += `‚Ä¢ Easy: ${playerStats.difficultyStats.easy.games} games (${playerStats.difficultyStats.easy.wins} wins)\n`;
        statsText += `‚Ä¢ Medium: ${playerStats.difficultyStats.medium.games} games (${playerStats.difficultyStats.medium.wins} wins)\n`;
        statsText += `‚Ä¢ Hard: ${playerStats.difficultyStats.hard.games} games (${playerStats.difficultyStats.hard.wins} wins)\n`;
        
        // Copy to clipboard
        navigator.clipboard.writeText(statsText).then(() => {
          this.showShareResult('Player stats copied to clipboard! üìã', 'success');
        }).catch(() => {
          this.showShareResult('Failed to copy stats. Try again!', 'error');
        });
      }

      // Download status card as image
      async downloadStatusCard() {
        if (!walletConnected || !userAddress) {
          this.showShareResult('Please connect your wallet first! üîó', 'error');
          return;
        }

        try {
          this.showShareResult('üé® Creating your status card...', 'info');
          
          // Generate the status card image
          const imageDataUrl = await this.generatePlayerStatusCard();
          
          // Create download link
          const link = document.createElement('a');
          link.download = `minesweeper-status-${userAddress.slice(0,6)}.png`;
          link.href = imageDataUrl;
          
          // Trigger download
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          this.showShareResult('Status card downloaded! üñºÔ∏è', 'success');
          
        } catch (error) {
          console.error('Error generating status card:', error);
          this.showShareResult('Error creating status card. Please try again.', 'error');
        }
      }
    }

    // Initialize game when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      // Create game instance
      window.gameInstance = new Minesweeper();
      
      // Initialize wallet UI
      await updateWalletUI();

      // Wait for Farcaster SDK to be ready
      if (window.farcasterSdk) {
        try {
          // Initialize Farcaster SDK
          await window.farcasterSdk.actions.ready();
          console.log("‚úÖ Farcaster Mini App SDK ready");

          // Check if user is already authenticated in Farcaster
          const context = await window.farcasterSdk.context;
          if (context?.user) {
            console.log("Farcaster user context:", context.user);
            farcasterUser = context.user;
            
            // Show user info in game
            window.gameInstance.showShareResult(`üëã Welcome ${context.user.displayName || context.user.username || 'Farcaster User'}!`, "info");
          }

        } catch (error) {
          console.error("Farcaster SDK initialization failed:", error);
        }
      } else {
        console.log("Farcaster SDK not available, running in fallback mode");
      }

      // Show initial connection prompt
      setTimeout(() => {
        if (!walletConnected) {
          window.gameInstance.showShareResult("Click 'Connect Wallet' to start playing! üéÆ", "info");
          window.gameInstance.disableGame();
        }
      }, 1500);
    });
  </script>
</body>
</html>
