<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minesweeper - Farcaster Game</title>

  <!-- Essential Open Graph Meta Tags -->
  <meta property="og:title" content="💣 Minesweeper Game" />
  <meta property="og:description" content="Can you clear the minefield? 3 difficulty levels, beat the clock, mobile-friendly!" />
  <meta property="og:image" content="https://minesweeper-game-pearl.vercel.app/assets/preview.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="https://minesweeper-game-pearl.vercel.app/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Minesweeper Game" />

  <!-- Farcaster Miniapp Meta -->
  <meta name="fc:miniapp" content='{"version":"1","imageUrl":"https://minesweeper-game-pearl.vercel.app/assets/preview.png","button":{"title":"Play","action":{"type":"launch_frame","name":"Minesweeper","url":"https://minesweeper-game-pearl.vercel.app/","splashImageUrl":"https://minesweeper-game-pearl.vercel.app/assets/splash.png","splashBackgroundColor":"#667eea"}}}' />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="💣 Minesweeper Game" />
  <meta name="twitter:description" content="Can you clear the minefield? Play Minesweeper on Farcaster!" />
  <meta name="twitter:image" content="https://minesweeper-game-pearl.vercel.app/assets/preview.png" />

  <meta name="description" content="Play Minesweeper on Farcaster! Mobile-friendly game with 3 difficulty levels. Share your results and challenge friends." />
  <meta name="keywords" content="minesweeper, farcaster, game, puzzle, mobile, web3" />
  <meta name="author" content="vidhyadar.base.eth" />

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk'
    window.farcasterSdk = sdk;
  </script>

  <style>
    * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: white;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            width: 100%;
        }

        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .game-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .difficulty-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .difficulty-btn {
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: 60px;
        }

        .difficulty-btn.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: bold;
        }

        /* Enhanced mode toggle button styling */
        #toggle-mode {
            position: relative;
            overflow: hidden;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #toggle-mode.dig-mode {
            background: rgba(76, 175, 80, 0.8);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        #toggle-mode.flag-mode {
            background: rgba(244, 67, 54, 0.8);
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.3);
        }

        #toggle-mode:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .minefield {
            display: grid;
            gap: 2px;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 0 auto;
            max-width: 100%;
            overflow: auto;
        }

        .cell {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .cell:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }

        .cell.revealed {
            background: rgba(255, 255, 255, 0.6);
            cursor: default;
        }

        .cell.revealed:hover {
            transform: none;
        }

        .cell.flagged {
            background: rgba(255, 100, 100, 0.8);
            color: white;
        }

        .cell.mine {
            background: rgba(255, 0, 0, 0.8);
            color: white;
            animation: explode 0.5s ease-out;
        }

        .cell.false-flag {
            background: rgba(255, 69, 0, 0.9);
            color: white;
            animation: shake 0.5s ease-out;
        }

        @keyframes explode {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .cell.number-1 { color: #0066cc; }
        .cell.number-2 { color: #009900; }
        .cell.number-3 { color: #ff0000; }
        .cell.number-4 { color: #000080; }
        .cell.number-5 { color: #800000; }
        .cell.number-6 { color: #008080; }
        .cell.number-7 { color: #000000; }
        .cell.number-8 { color: #808080; }

        .game-message {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .game-message.win {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .game-message.lose {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
        }

        .instructions {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            line-height: 1.4;
        }

        .share-section {
            margin-top: 15px;
            text-align: center;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(138, 43, 226, 0.8);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .share-btn:hover {
            background: rgba(138, 43, 226, 1);
            transform: translateY(-2px);
        }

        .share-btn.warpcast {
            background: rgba(139, 69, 255, 0.8);
        }

        .share-btn.warpcast:hover {
            background: rgba(139, 69, 255, 1);
        }

        .share-result {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 8px;
            color: #00ff88;
            font-size: 0.9rem;
            border: 1px solid rgba(0, 255, 0, 0.3);
            display: none;
        }

        /* Sound toggle button */
        .sound-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 15px;
                margin: 10px;
            }
            
            .game-title {
                font-size: 1.5rem;
            }
            
            .cell {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .difficulty-buttons {
                flex-wrap: wrap;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 8px 15px;
            }

            .sound-toggle {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }
  </style>
</head>
<body>
  <!-- Sound toggle button -->
  <button class="sound-toggle" id="sound-toggle">🔊</button>

  <div class="game-container">
    <div class="game-header">
      <h1 class="game-title">💣 Minesweeper</h1>
    </div>

    <div class="difficulty-buttons">
      <button class="btn difficulty-btn active" data-difficulty="easy">Easy</button>
      <button class="btn difficulty-btn" data-difficulty="medium">Medium</button>
      <button class="btn difficulty-btn" data-difficulty="hard">Hard</button>
    </div>

    <div class="game-stats">
      <div class="stat">
        <span>Mines</span>
        <span class="stat-value" id="mines-count">10</span>
      </div>
      <div class="stat">
        <span>Flags</span>
        <span class="stat-value" id="flags-count">0</span>
      </div>
      <div class="stat">
        <span>Time</span>
        <span class="stat-value" id="timer">0</span>
      </div>
    </div>

    <div class="game-controls">
      <button class="btn" id="new-game">New Game</button>
      <button class="btn dig-mode" id="toggle-mode">👆 Reveal Mode</button>
    </div>

    <div class="minefield" id="minefield"></div>
    <div class="game-message" id="game-message"></div>

    <div class="share-section">
      <div class="share-result" id="share-result">Link copied to clipboard! 📋</div>
      <div class="share-buttons">
        <button class="share-btn" id="share-warpcast">🟣 Share on Warpcast</button>
        <button class="share-btn" id="share-general">🔗 Copy Game Link</button>
        <button class="share-btn" id="share-result-btn" style="display: none;">🏆 Share Result</button>
      </div>
    </div>

    <div class="instructions">
      <strong>How to play:</strong><br>
      • Tap to reveal cells<br>
      • Use Flag Mode to mark mines<br>
      • Numbers show nearby mines<br>
      • Find all mines to win!
    </div>
  </div>

  <script>
  // ----- WALLET CONNECTION -----
  let walletConnected = false;
  let provider, signer, userAddress;

  async function connectWallet() {
    if (walletConnected) return true;
    try {
      if (!window.ethereum) {
        alert("MetaMask or a Web3 wallet is required!");
        return false;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      console.log("✅ Wallet connected:", userAddress);
      walletConnected = true;
      return true;
    } catch (err) {
      console.error("❌ Wallet connection failed:", err);
      alert("Wallet connection failed!");
      return false;
    }
  }

  // ----- NFT MINT FUNCTION -----
  async function captureAndMint(result) {
    try {
      const canvas = await html2canvas(document.querySelector(".game-container"));
      const image = canvas.toDataURL("image/png");

      const metadata = {
        name: `Minesweeper - ${result.win ? "Victory" : "Defeat"}`,
        description: `Difficulty: ${result.difficulty}, Time: ${result.time}s`,
        image,
        attributes: [
          { trait_type: "Difficulty", value: result.difficulty },
          { trait_type: "Time", value: result.time },
          { trait_type: "Result", value: result.win ? "Win" : "Lose" }
        ]
      };

      const tokenURI =
        "data:application/json;base64," + btoa(JSON.stringify(metadata));

      // 🔴 Replace with your deployed NFT contract address
      const CONTRACT_ADDRESS = "0xYourNFTContractHere";
      const CONTRACT_ABI = [
        "function mintGameNFT(address to, string memory tokenURI) public returns (uint256)"
      ];

      const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

      const tx = await contract.mintGameNFT(userAddress, tokenURI, {
        gasLimit: 200000
      });

      alert("⏳ Minting started! Tx: " + tx.hash);
      await tx.wait();
      alert("✅ NFT Minted Successfully!");
    } catch (err) {
      console.error("❌ Mint failed:", err);
      alert("Mint failed: " + err.message);
    }
  }

  // ----- GAME INITIALIZATION -----
  class Minesweeper {
    constructor() {
      this.gameState = "ready";
      this.flagMode = false;
      this.firstClick = true;
      this.timer = 0;
      this.timerInterval = null;
      this.soundEnabled = true;

      this.difficulties = {
        easy: { rows: 9, cols: 9, mines: 10 },
        medium: { rows: 12, cols: 12, mines: 20 },
        hard: { rows: 15, cols: 15, mines: 35 }
      };

      this.currentDifficulty = "easy";
      this.config = this.difficulties.easy;
      this.board = [];
      this.revealed = [];
      this.flagged = [];

      this.createSounds();
      this.initializeGame();
      this.setupEventListeners();
    }

    /* keep all your existing Minesweeper methods here */

    setupEventListeners() {
      document.getElementById("toggle-mode")
        .addEventListener("click", () => this.toggleMode());
      document.querySelectorAll(".difficulty-btn").forEach((btn) => {
        btn.addEventListener("click", (e) =>
          this.changeDifficulty(e.target.dataset.difficulty)
        );
      });

      document.getElementById("sound-toggle").addEventListener("click", () => {
        this.soundEnabled = !this.soundEnabled;
        document.getElementById("sound-toggle").textContent = this.soundEnabled
          ? "🔊"
          : "🔇";
      });

      document.getElementById("share-result-btn").addEventListener("click", async () => {
        if (!walletConnected) {
          const connected = await connectWallet();
          if (!connected) return;
        }

        if (this.gameState === "ready" || this.gameState === "playing") {
          this.showShareResult("Finish the game first! 🎮", "error");
          return;
        }

        const doMint = confirm(
          "Do you want to mint this game result as an NFT? (Optional, low gas)"
        );
        if (doMint) {
          const result = {
            difficulty: this.currentDifficulty,
            time: this.timer,
            win: this.gameState === "won"
          };
          await captureAndMint(result);
        } else {
          this.shareResult();
        }
      });
    }
  }

  // ----- FORCE WALLET BEFORE NEW GAME -----
  document.addEventListener("DOMContentLoaded", async () => {
    window.gameInstance = new Minesweeper();

    document.getElementById("new-game").addEventListener("click", async () => {
      if (!walletConnected) {
        const connected = await connectWallet();
        if (!connected) return;
      }
      window.gameInstance.initializeGame();
    });

    if (window.farcasterSdk?.actions?.ready) {
      window.farcasterSdk.actions.ready();
      console.log("✅ Mini App ready() called");
    }
  });
</script>

  <script>
    // ----- MINESWEEPER CLASS (unchanged logic, only additions for wallet + NFT mint) -----
    class Minesweeper {
      constructor() {
        this.gameState = 'ready';
        this.flagMode = false;
        this.firstClick = true;
        this.timer = 0;
        this.timerInterval = null;
        this.soundEnabled = true;

        this.difficulties = {
          easy: { rows: 9, cols: 9, mines: 10 },
          medium: { rows: 12, cols: 12, mines: 20 },
          hard: { rows: 15, cols: 15, mines: 35 }
        };

        this.currentDifficulty = 'easy';
        this.config = this.difficulties.easy;
        this.board = [];
        this.revealed = [];
        this.flagged = [];

        this.createSounds();
        this.initializeGame();
        this.setupEventListeners();
      }

      /* ... [All previous Minesweeper methods remain unchanged] ... */

      setupEventListeners() {
        // Difficulty & Mode buttons
        document.getElementById('toggle-mode').addEventListener('click', () => this.toggleMode());
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
          btn.addEventListener('click', (e) => this.changeDifficulty(e.target.dataset.difficulty));
        });

        // Sound toggle
        document.getElementById('sound-toggle').addEventListener('click', () => {
          this.soundEnabled = !this.soundEnabled;
          document.getElementById('sound-toggle').textContent = this.soundEnabled ? '🔊' : '🔇';
        });

        // Share buttons
        document.getElementById('share-warpcast').addEventListener('click', () => this.shareToWarpcast());
        document.getElementById('share-general').addEventListener('click', () => this.copyGameLink());

        // Share / Mint Result
        document.getElementById('share-result-btn').addEventListener('click', async () => {
          if (!walletConnected) {
            const connected = await connectWallet();
            if (!connected) return;
          }

          if (this.gameState === 'ready' || this.gameState === 'playing') {
            this.showShareResult('Finish the game first! 🎮', 'error');
            return;
          }

          const doMint = confirm("Do you want to mint this game result as an NFT? (Optional, low gas)");
          if (doMint) {
            const result = {
              difficulty: this.currentDifficulty,
              time: this.timer,
              win: this.gameState === 'won',
            };
            await captureAndMint(result);
          } else {
            this.shareResult();
          }
        });
      }
    }

    // ----- INIT GAME -----
    document.addEventListener('DOMContentLoaded', () => {
      window.gameInstance = new Minesweeper();

      if (window.farcasterSdk?.actions?.ready) {
        window.farcasterSdk.actions.ready();
        console.log("✅ Mini App ready() called");
      } else {
        console.error("❌ Mini App SDK not available");
      }
    });

    // ----- OVERRIDE NEW GAME BUTTON FOR WALLET -----
    document.getElementById('new-game').addEventListener('click', async (e) => {
      if (!walletConnected) {
        const connected = await connectWallet();
        if (!connected) return;
      }
      window.gameInstance.initializeGame();
    });
  </script>

  <!-- Mint NFT script -->
  <script type="module" src="mint.js"></script>
</body>
</html>

